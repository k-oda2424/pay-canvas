# 美容室向けSaaS型給与計算システム 内部設計書

## 1. アプリケーション構成

### 1.1 レイヤー構造
- **Presentation Layer (SPA)**: React/Vueで構築。APIクライアント、状態管理（Redux/Pinia）、共通UIコンポーネントで構成。認証済みリクエストにJWTを添付する。
- **API Gateway / Controller Layer** (Spring MVC): HTTPエンドポイントを提供し、リクエストバリデーションと認可判定を担当。
- **Service Layer**: ビジネスロジックを実装。トランザクション境界を定義し、ドメインロジックを集約する。
- **Domain Model Layer**: エンティティ、値オブジェクト、集約ルートを定義し、ドメインルールをカプセル化。
- **Persistence Layer**: Spring Data JPA + Hibernate。マルチテナントフィルタ、クエリ仕様、リポジトリを提供。
- **Integration Layer**: 外部APIクライアント（KING OF TIME、CSVインポート）、会計CSVエクスポート、メッセージキュー（必要に応じて）を管理。

### 1.2 マルチテナント制御
- リクエストコンテキストで`companyId`を保持。
- Hibernate Filter/Interceptorで全クエリに`company_id = :companyId`を適用。
- スーパー管理者はシステム管理用スキーマにアクセスし、テナント固有データにはアクセスしない。

---

## 2. モジュール構成

| モジュール | 主な責務 |
| :--- | :--- |
| `auth` | 認証、認可、JWT発行・検証、パスワードハッシュ化。 |
| `tenant` | テナント登録、機能フラグ管理、契約ステータス変更。 |
| `master-data` | 従業員、店舗、等級、給与テーブル等のCRUD。 |
| `daily-metrics` | 勤怠・売上データ取得、補正、CSVインポート、外部API連携。 |
| `payroll` | 月次給与計算、歩合・手当算出、給与確定、CSVエクスポート。 |
| `bonus` | 賞与スケジュール管理、半期集計、支給処理。 |
| `reporting` | KPI集計、ダッシュボードAPI、通知生成。 |
| `common` | 例外ハンドラ、ロギング、ユーティリティ、設定管理。 |

---

## 3. データフロー

### 3.1 勤怠・売上連携
1. バッチ/ジョブがKING OF TIME APIより勤怠データを取得し、`t_daily_attendances`をアップサート。
2. POS連携またはCSVインポートで売上データを`t_daily_store_metrics`および`t_daily_personal_metrics`に格納。
3. データ補正画面で会社管理者が修正すると、更新履歴を`audit_logs`テーブル（将来拡張）に記録。

### 3.2 月次給与計算
1. 会社管理者が対象年月を指定し計算実行APIを呼び出す。
2. `payroll`サービスが前処理（欠損チェック、日次データ集計）を実施。
3. 各従業員の給与構成要素を計算し、`t_monthly_payrolls`のステージング領域に保存。
4. 確定操作でステータスを`CONFIRMED`に更新し、会計CSVを生成。
5. 確定後の変更は再計算フロー（差分保存）で対応。

### 3.3 賞与計算
- 半期締めcronジョブが`t_bonuses`を集計し、支給対象者と金額を算出。
- Payroll計算と連携し支給月の給与明細に統合。

---

## 4. セキュリティ設計
- Spring Securityでロールベースのアクセス制御を実装。
- End-to-End SSL/TLS、HTTP Strict Transport Securityを有効化。
- JWTには短期有効期限（15分）＋リフレッシュトークン。ブラックリストで強制ログアウト対応。
- 監査ログ：認証、権限エラー、重要マスタ更新、給与確定処理を記録。

---

## 5. エラーハンドリングとロギング
- コントローラで`@ControllerAdvice`を使用し、ビジネス例外（400系）、認可例外（403）、サーバ例外（500）を統一レスポンス。
- サービス層で業務エラーコードを定義（例: `PAYROLL_VALIDATION_ERROR`）。
- エラー発生時にSentry等へ通知、ユーザ向けメッセージはローカライズ。

---

## 6. バッチおよびスケジューラ
- Spring Batch/Quartzで外部データ取り込み（毎朝5時）、賞与集計（月末）、ダッシュボード再計算（毎時）をスケジュール。
- ジョブメタデータを専用テーブルに保持し、再実行可能にする。

---

## 7. パフォーマンス・可用性対策
- 読み取り頻度の高いマスタにキャッシュ（Redis）を適用。
- 月次計算は非同期ジョブで処理し、進捗をWebSocket/ポーリングで通知。
- スケールアウトを前提に、Stateless設計とし、セッション情報はRedis等に保存。

---

## 8. テスト戦略
- ユニットテスト: Service/Domain層の計算ロジックをJUnitで網羅。
- 統合テスト: Controller〜DB間のシナリオをSpring Testで実施。
- E2Eテスト: Cypressなどで主要画面フロー（勤怠確認→給与計算→明細確認）を自動化。
- パフォーマンステスト: Gatling/JMeterで月末ピークを想定した負荷試験。

---

## 9. 運用・監視
- インフラ監視: CPU、メモリ、DB接続数、ジョブ失敗数をダッシュボード化。
- アプリ監視: 重要APIのAPMトレース、エラーレート監視。
- アラート: SLA逸脱（レスポンス>2秒）、ジョブ失敗、CSV連携失敗で通知。
- 運用ツール: 管理画面からテナント状態、機能フラグ、ジョブ実行履歴を確認可能にする。
