# 美容室向けSaaS型給与計算システム 外部設計書

## 1. システム概要

### 1.1. 目的
複数の美容室運営会社（テナント）が、それぞれ独自の複雑な給与体系に基づいて、従業員の給与を日次で計算し、月次で集計・管理するためのSaaS型Webアプリケーションを開発する。

### 1.2. アーキテクチャ
- **フロントエンド**: SPA (Single Page Application) - React または Vue.js
- **バックエンド**: Java (Spring Boot)
- **データベース**: PostgreSQL
- **テナントモデル**: 共有スキーマ・マルチテナント方式を採用し、全テナントのデータを単一のデータベースで管理する。データの分離はアプリケーション層で厳密に行う。

### 1.3. ユーザー権限
1.  **スーパー管理者**: システム全体を管理。テナント（会社）の登録や機能の有効/無効を設定する。
2.  **会社管理者**: テナントの管理者。自社の従業員や店舗の管理、給与計算の実行、各種設定を行う。
3.  **一般スタッフ**: テナントに所属する従業員。自身の給与明細や勤怠情報を閲覧する。

---

## 2. データベース設計
データベース詳細は `docs/beauty-salon-payroll-db-design.md` を参照。

---

## 3. API設計

### 3.1. 認証とデータ分離
- **認証**: ログイン時にJWTを発行。ペイロードに`user_id`, `company_id`, `role`, `enabled_features`を含める。
- **データ分離**: バックエンドは全リクエストでJWTを検証。永続層（Hibernate Filters等）で、JWT内の`company_id`に基づき、全DBクエリに`WHERE company_id = ?`を自動適用する。

### 3.2. エンドポイント一覧 (主要)
- `POST /api/auth/login`: ログイン
- `GET /api/staff`: スタッフ一覧取得
- `POST /api/staff`: スタッフ新規登録
- `GET /api/payroll/execute`: 給与計算実行
- `GET /api/payslips/{year}/{month}`: 月次給与明細一覧取得
- `GET /api/payslips/{year}/{month}/{employeeId}`: 個人給与明細取得
- `POST /api/super/companies`: (スーパー管理者) 新規会社登録
- `PUT /api/super/companies/{id}/features`: (スーパー管理者) 機能フラグ設定

---

## 4. 主要ビジネスロジック

- **給与計算**: 月末締め。日次テーブル(`t_daily_*`)のデータを1ヶ月分集計し、各種マスタ(`m_*`)のルールに基づいて手当・控除を算出し、`t_monthly_payrolls`に結果を保存する。
- **歩合計算**: 店舗の1日の売上を、減免率を考慮したスタッフ数（人工）で割り、個人の配当額を算出。等級に応じた歩合率を適用する。最低保証給と比較し、高い方を支給。
- **賞与計算**: `t_bonuses`に蓄積されたレコードを半期ごと（1-6月、7-12月）に集計し、7月と1月の給与支払日に支給する。
- **機能フラグ**: フロントエンドはログイン時に取得した`enabled_features`リストに基づき、メニューやボタンを動的に表示/非表示。バックエンドはAPI実行時に機能の有効性を検証し、無効な機能へのアクセスは拒否する。

---

## 5. 画面設計

1.  **ログイン画面**: メール、パスワードで認証。
2.  **ダッシュボード**: 役割（スーパー管理者/会社管理者/一般スタッフ）に応じてKPIや通知を表示。
3.  **日次実績画面**: カレンダー形式で日々の勤怠・売上実績を確認・修正。
4.  **給与計算実行画面**: ウィザード形式でデータチェックから計算実行、結果確認、確定までをナビゲート。
5.  **給与明細画面**: 役割に応じて、全従業員または個人の給与明細を閲覧。
6.  **マスタ管理画面**: 各種マスタ（従業員、店舗、等級など）のCRUD操作。
7.  **機能設定画面 (スーパー管理者)**: 会社ごとに機能の有効/無効をトグルスイッチで設定。
