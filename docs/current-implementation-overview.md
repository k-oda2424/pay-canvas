# 現在の実装状況まとめ

## 1. 実装状況

- **スタック構成**: フロントエンドは Vite + React、バックエンドは Spring Boot (Flyway / Spring Data JPA) を採用。PostgreSQL を Docker Compose で起動。
- **認証基盤**: JWT とリフレッシュトークン方式。`AuthContext` がロール別メニューとトークン管理を担う。
- **マスタ管理 (Company Admin)**:
  - 従業員マスタ (`/staff/employees`)
  - 店舗マスタ (`/staff/stores`)
  - 等級マスタ (`/staff/grades`)
  - 給与プランマスタ (`/staff/salary`)
  各画面は登録／一覧／編集タブを備え、登録フォーム・一覧テーブル・編集フォームを切り替えて操作できる。
- **スーパー管理者 (Super Admin)**:
  - 利用企業管理 (`/super/companies`): 新規登録／一覧／編集をタブで提供。
  - 管理者登録 (`/super/users`): 利用企業選択のうえ会社管理者ユーザーを作成。
- **従業員と店舗の連携**: `m_employees` テーブルは `store_id` を保持し、`m_stores` に外部キー連携。Flyway マイグレーション `V7__employees_store_fk.sql` が既存データを `store_name` から `store_id` へ移行。

## 2. 画面仕様

### 従業員マスタ `/staff/employees`
- 内部タブ:
  - `登録`: 等級・給与プラン・店舗を選択できるフォーム。登録成功時に完了メッセージを表示。
  - `一覧`: 氏名昇順でソートされた従業員一覧。`編集` ボタンで編集タブを開く。
  - `編集`: 一覧で選択した従業員の内容を修正。キャンセルでフォームをクリア。
- その他: 削除操作時には確認ダイアログを表示し、完了後は対象がリストから削除される。

### 店舗マスタ `/staff/stores`
- `登録`: 店舗名・種別・住所を入力。登録後はフォームをリセット。
- `一覧`: 店舗名昇順で表示。`編集` ボタンで対象を編集タブに読み込み。
- `編集`: 店舗情報を更新、またはキャンセルでフォームを戻す。
- `削除`: ダイアログで確認してから実行。

### 等級マスタ `/staff/grades`
- `登録`: 等級名と歩合率(%)を入力。内部では小数に変換して保存。
- `一覧`: 歩合率を `%` 表記で表示。編集対象の選択は一覧から行う。
- `編集`: 値を修正して更新。キャンセルでフォームクリア。

### 給与プランマスタ `/staff/salary`
- `登録`: プラン名・月間休日数・基本給を入力。
- `一覧`: 基本給は `¥12,345` のような通貨表記。編集ボタンで編集タブへ。
- `編集`: 数値項目にはゼロ以上のバリデーション。

### 利用企業管理 `/super/companies`
- `登録`: 企業名や連絡担当者を入力。登録後にメッセージ表示。
- `一覧`: 会社名でソート。`編集` ボタンで編集タブへ遷移。
- `編集`: 詳細を更新し、キャンセルでフォームを閉じる。

### 管理者登録 `/super/users`
- 利用企業のプルダウン + メール・表示名・仮パスワードを入力。登録完了メッセージを表示。

## 3. DB 設計要約

### 主なテーブル
- `m_companies`: 企業基本情報と連絡先。
- `m_stores`: 店舗情報 (`company_id` FK)。`V3__store_master.sql`, `V5__add_store_address.sql` で拡張。
- `m_employee_grades`: 等級。`commission_rate` を小数で保持。
- `m_salary_tiers`: 給与プラン。プラン名・休日数・基本給。
- `m_employees`: 従業員 (`grade_id`, `salary_tier_id`, `store_id` を FK で保持)。`V7__employees_store_fk.sql` で `store_id` を追加し `store_name` を廃止。
- `m_roles`, `m_users`, `t_refresh_tokens`: 認証基盤。
- `t_daily_*`: 日次実績・個人実績などの集計テーブル。

### マイグレーション
- `V1__initial_schema.sql`: 基本スキーマとサンプルデータ。
- `V3__store_master.sql`: 店舗マスタの初期データ投入。
- `V5__add_store_address.sql`: 店舗住所列の追加。
- `V7__employees_store_fk.sql`: `store_id` 追加と既存データの移行、`store_name` 列の削除、インデックス作成。

### 関連付け
- 従業員 → 等級・給与プラン・店舗は任意（FK = NULL 可）が、存在チェックは Flyway の制約＋サービス層で実施。
- 全マスタはデフォルト会社（ID=1）に紐付き、Super Admin 画面から利用企業を管理する構成。

---

この資料は 2024-XX-XX 時点の実装状況をまとめたものです。以降の改修で変更が入った場合は適宜更新してください。
